name: Create release

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: false

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - 'void-packages/srcpkgs/ungoogled-chromium/**'

jobs:
  Fetch:
    if: github.repository == 'DAINRA/ungoogled-chromium-void'
    runs-on: self-hosted
    outputs:
      ver: ${{ steps.version.outputs.ver }}
      rev: ${{ steps.version.outputs.rev }}
      skip_ci: ${{ steps.ci_skip_check.outputs.skip_ci }}
    environment:
      name: release
    steps:
      - name: Check for [ci-skip] in commit message
        id: ci_skip_check
        run: |
          if echo "${{ github.event.head_commit.message }}" | grep -iqE '\[ci-skip\]|\[skip ci\]'; then
            echo "CI skip detected. Skipping further steps."
            echo "skip_ci=true" >> $GITHUB_OUTPUT
          else
            echo "skip_ci=false" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Fetch repository
        if: steps.ci_skip_check.outputs.skip_ci == 'false'
        uses: actions/checkout@v4
        with:
          path: master

      - name: Fetch void-packages
        if: steps.ci_skip_check.outputs.skip_ci == 'false'
        uses: actions/checkout@v4
        with:
          repository: void-linux/void-packages
          path: void-packages

      - name: Configure void-packages
        if: steps.ci_skip_check.outputs.skip_ci == 'false'
        run: |
          cp -r master/void-packages ./ 2>/dev/null

      - id: version
        if: steps.ci_skip_check.outputs.skip_ci == 'false'
        run: |
          echo "ver=$( grep -m 1 'version=' master/void-packages/srcpkgs/ungoogled-chromium/template | awk -F '=' '{ print $2 }' )" >> $GITHUB_OUTPUT
          echo "rev=$( grep -m 1 'revision=' master/void-packages/srcpkgs/ungoogled-chromium/template | awk -F '=' '{ print $2 }' )" >> $GITHUB_OUTPUT

  Bootstrap:
    needs: [Fetch]
    if: needs.Fetch.outputs.skip_ci == 'false'
    strategy:
      max-parallel: 1
      matrix:
        arch: [x86_64, x86_64-musl]
    runs-on: self-hosted
    steps:
      - name: Bootstrap ${{ matrix.arch }}
        run: |
          cd void-packages
          ./xbps-src -H /repository -A ${{ matrix.arch }} binary-bootstrap
          ./xbps-src -H /repository -A ${{ matrix.arch }} fetch ungoogled-chromium

  Configure:
    needs: [Bootstrap]
    if: needs.Fetch.outputs.skip_ci == 'false'
    strategy:
      max-parallel: 1
      matrix:
        arch: [x86_64, x86_64-musl]
    runs-on: self-hosted
    steps:
      - name: Configure ${{ matrix.arch }}
        run: |
          cd void-packages
          ./xbps-src -H /repository -A ${{ matrix.arch }} -C configure ungoogled-chromium

  Build:
    needs: [Fetch, Configure]
    if: needs.Fetch.outputs.skip_ci == 'false'
    strategy:
      max-parallel: 1
      matrix:
        arch: [x86_64, x86_64-musl]
    runs-on: self-hosted
    timeout-minutes: 1440
    env:
      XBPS_TARGET_ARCH: ${{ matrix.arch }}
      XBPS_PASSPHRASE: ${{ secrets.SUPERBIA }}
    steps:
      - name: Build ${{ matrix.arch }}
        run: |
          cd void-packages
          ./xbps-src -H /repository -A ${{ matrix.arch }} -C pkg ungoogled-chromium

      - name: Sign ${{ matrix.arch }} package
        run: |
          cd /repository/binpkgs
          rm -f ${{ matrix.arch }}-repodata
          xbps-rindex -a ungoogled-chromium-${{ needs.Fetch.outputs.ver }}_${{ needs.Fetch.outputs.rev }}.${{ matrix.arch }}.xbps
          xbps-rindex -a ungoogled-chromium-qt6-${{ needs.Fetch.outputs.ver }}_${{ needs.Fetch.outputs.rev }}.${{ matrix.arch }}.xbps
          xbps-rindex --sign --signedby "Shiraori archive" --privkey /repository/shiraori.pem $PWD
          xbps-rindex --sign-pkg --privkey /repository/shiraori.pem ungoogled-chromium-${{ needs.Fetch.outputs.ver }}_${{ needs.Fetch.outputs.rev }}.${{ matrix.arch }}.xbps
          xbps-rindex --sign-pkg --privkey /repository/shiraori.pem ungoogled-chromium-qt6-${{ needs.Fetch.outputs.ver }}_${{ needs.Fetch.outputs.rev }}.${{ matrix.arch }}.xbps

      - name: Release ${{ matrix.arch }} assets
        uses: softprops/action-gh-release@v2
        with:
          body: |
            Chromium release: <a href='https://chromium.googlesource.com/chromium/src/+/refs/tags/${{ needs.Fetch.outputs.ver }}'>${{ needs.Fetch.outputs.ver }}</a>
            Ungoogled Chromium release: <a href='https://github.com/ungoogled-software/ungoogled-chromium/releases/tag/${{ needs.Fetch.outputs.ver }}-${{ needs.Fetch.outputs.rev }}'>${{ needs.Fetch.outputs.ver }}-${{ needs.Fetch.outputs.rev }}</a>
          files: |
            /repository/binpkgs/ungoogled-chromium-${{ needs.Fetch.outputs.ver }}_${{ needs.Fetch.outputs.rev }}.${{ matrix.arch }}.xbps
            /repository/binpkgs/ungoogled-chromium-qt6-${{ needs.Fetch.outputs.ver }}_${{ needs.Fetch.outputs.rev }}.${{ matrix.arch }}.xbps
            /repository/binpkgs/ungoogled-chromium-${{ needs.Fetch.outputs.ver }}_${{ needs.Fetch.outputs.rev }}.${{ matrix.arch }}.xbps.sig2
            /repository/binpkgs/ungoogled-chromium-qt6-${{ needs.Fetch.outputs.ver }}_${{ needs.Fetch.outputs.rev }}.${{ matrix.arch }}.xbps.sig2
            /repository/binpkgs/${{ matrix.arch }}-repodata
          tag_name: ${{ needs.Fetch.outputs.ver }}_${{ needs.Fetch.outputs.rev }}

  Cleanup:
    needs: [Build]
    if: needs.Fetch.outputs.skip_ci == 'false'
    runs-on: self-hosted
    steps:
      - name: Cleanup old release files
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: 5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

